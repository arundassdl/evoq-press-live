---
- name: Check if Filebeat is already installed and running
  shell: systemctl is-active filebeat
  register: filebeat_running
  ignore_errors: yes
  changed_when: false

- name: Update APT Cache
  apt:
    update_cache: yes
  ignore_errors: yes
  when: filebeat_running.rc != 0

- name: Install Filebeat Dependencies
  apt:
    state: present
    pkg:
      - apt-transport-https
      - ca-certificates
      - curl
      - software-properties-common
  register: result
  until: result.failed == false
  retries: 5
  delay: 120
  when: filebeat_running.rc != 0

- name: Add Elasticsearch Repository Key
  shell: |
    curl -fsSL https://artifacts.elastic.co/GPG-KEY-elasticsearch | gpg --dearmor -o /etc/apt/trusted.gpg.d/elasticsearch.gpg
  args:
    creates: /etc/apt/trusted.gpg.d/elasticsearch.gpg

- name: Add Elasticsearch Repository
  apt_repository:
    repo: deb https://artifacts.elastic.co/packages/7.x/apt stable main
    state: present
  when: filebeat_running.rc != 0

- name: Remove new Elasticsearch Repository
  apt_repository:
    repo: deb https://artifacts.elastic.co/packages/8.x/apt stable main
    state: absent
    update_cache: true
  when: filebeat_running.rc != 0

- name: Uninstall newer version of Filebeat
  apt:
    name: filebeat
    state: absent
  register: result
  until: result.failed == false
  retries: 5
  delay: 120
  when: filebeat_running.rc != 0

- name: Install Filebeat
  apt:
    name: filebeat
    state: present  # Changed from 'latest' to 'present' to avoid unnecessary upgrades
  register: result
  until: result.failed == false
  retries: 5
  delay: 120

- name: Setup Filebeat
  template:
    src: filebeat.yml
    dest: /etc/filebeat/filebeat.yml
  notify: restart filebeat  # Use handler instead of direct restart

- name: Create ProxySQL Module Directory
  file:
    path: /usr/share/filebeat/module/proxysql
    state: directory
    owner: root

- name: Setup ProxySQL Module
  copy:
    src: 'roles/filebeat/module/proxysql/'
    dest: /usr/share/filebeat/module/proxysql/
    owner: root
    group: root
    mode: '0755'

- name: Setup Filebeat Modules
  template:
    src: 'modules.d/{{ item }}.yml'
    dest: '/etc/filebeat/modules.d/{{ item }}.yml'
  loop:
    - 'mysql'
    - 'system'
    - 'nginx'
    - 'proxysql'
  notify: restart filebeat

- name: Enable Filebeat Modules
  command: filebeat modules enable nginx mysql system proxysql
  changed_when: false  # This is idempotent

- name: Create Filebeat Modules Directory
  file:
    dest: /etc/filebeat/inputs.d
    state: directory

- name: Setup Filebeat Inputs
  template:
    src: 'inputs.d/{{ item }}.yml'
    dest: '/etc/filebeat/inputs.d/{{ item }}.yml'
  loop:
    - 'all'
    - 'containers'
    - 'monitor'
  notify: restart filebeat

- name: Ensure Filebeat is enabled and started
  systemd:
    name: filebeat
    daemon_reload: true
    enabled: yes
    state: started  # Changed from 'restarted' to 'started'
